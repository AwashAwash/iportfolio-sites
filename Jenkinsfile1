pipeline {
    agent any

    environment {
        PROJECT_NAME = 'Awash Portfolio'
        BUILD_ENV = 'production'
        GIT_SHORT_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
        BUILD_TIMESTAMP = sh(script: 'date +%Y-%m-%d_%H:%M:%S', returnStdout: true).trim()
    }

    options {
        timestamps()
        timeout(time: 20, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    parameters {
        choice(name: 'ENV', choices: ['dev', 'staging', 'production'], description: 'Target Environment')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Run unit/integration tests?')
        booleanParam(name: 'RUN_SECURITY_SCAN', defaultValue: true, description: 'Run security checks?')
    }

    stages {
        stage('Preparation & Info') {
            steps {
                echo "üöÄ Starting ${PROJECT_NAME} CI Pipeline"
                echo "Environment: ${params.ENV}"
                echo "Build Number: ${env.BUILD_NUMBER}"
                echo "Commit: ${GIT_SHORT_COMMIT}"
                echo "Triggered by: ${env.BUILD_USER_ID ?: 'Unknown'}"
                sh 'printenv | grep -E "BUILD|JOB|GIT|PARAM"'
            }
        }

        stage('Parallel Quality Gates') {
            parallel {
                stage('Code Style (Lint)') {
                    steps {
                        echo "Running code linting (eslint, flake8, etc.)..."
                        sh 'sleep 2' // simulate real linting
                        echo "All style checks passed ‚úÖ"
                    }
                }

                stage('Unit & Integration Tests') {
                    when { expression { params.RUN_TESTS } }
                    steps {
                        echo "Executing unit & integration tests..."
                        sh 'sleep 5' // simulate test execution
                        echo "All tests passed (100% coverage) üéØ"
                    }
                }

                stage('Security Static Analysis') {
                    when { expression { params.RUN_SECURITY_SCAN } }
                    steps {
                        echo "Performing static security scan (SAST, dependency check)..."
                        sh 'sleep 3'
                        echo "No critical vulnerabilities found üîí"
                    }
                }
            }
        }

        stage('Build & Package Artifact') {
            steps {
                echo "Building & packaging application..."
                sh 'mkdir -p artifacts && echo "Build successful at ${BUILD_TIMESTAMP}" > artifacts/build-info.txt'
                sh 'echo "Version: ${GIT_SHORT_COMMIT}" >> artifacts/build-info.txt'
                sh 'echo "Environment: ${params.ENV}" >> artifacts/build-info.txt'
                archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: false
                echo "Artifact archived and fingerprinted"
            }
        }

        stage('Deploy Preview / Staging') {
            when { branch 'main' }
            steps {
                echo "Deploying preview/staging environment..."
                sh 'echo "Preview live at: https://preview.awashmasketech.co.uk/build-${BUILD_NUMBER}"'
            }
        }

        stage('Production Approval Gate') {
            when { branch 'main' }
            input {
                message "Approve deployment to Production?"
                ok "Yes - Deploy to Production"
                submitter "admin,awashawash" // add your username here
                submitterParameter 'APPROVER'
            }
            steps {
                echo "Production deployment approved by ${APPROVER}!"
            }
        }

        stage('Production Deployment') {
            when { branch 'main' }
            steps {
                echo "Deploying to production..."
                sh 'echo "Production deployment completed successfully üåü"'
            }
        }
    }

    post {
        always {
            echo "Pipeline finished - Result: ${currentBuild.currentResult}"
        }
        success {
            echo "üéâ Showcase pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed - review logs"
        }
        cleanup {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}
